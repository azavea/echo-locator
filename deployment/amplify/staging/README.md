## Steps to replicate this stack

This stack was generated using Amplify CLI v3.17.0. After generating the stack, some customization must be done manually, including adding code for two functions.


### Generating the initial configuration

Note that it is important to make modifications to the configuration as described in the next section *before* the first `amplify push` of the component for the modifications to be properly applied and not potentially overwritten by the Amplify CLI.

To generate another stack to host simultaneously on the same account as this stack, named Amplify components below should be given different names from those below (i.e., the stack name, environment name, S3 bucket name, Cognito user and identity pool names).

Named things that should remain consistent across stacks due to references in the UI are:

	- the `counselors` group name
	- the API endpoint names `/clients` and `/profiles`

Other identifiers given to the prompts should generally differ across stacks.

Regarding the read/write attribute steps below, the React Amplify library wants to have access to the phone number and whether the phone number is verified, so even though we aren't using phone numbers, select those fields during configuration (this caused an issue with an earlier version of the Amplify CLI).


#### Before starting

If you will be replacing an existing stack, first copy the `app.js` files for the functions (if any) before deleting the stack and its configuration files.


#### Amplify CLI steps

1. remove all existing configuration files for the stack, optionally first deleting the resources from AWS with the Amplify CLI
- `amplify init`
    1. stack name: `echolocatorStaging`
    2. environment name: `staging`
    3. (editor choice only applies to CLI)
    4. app type: javascript
    5. remaining JS choices don't matter (use defaults)
    6. use profile? yes (pick account profile)
- `amplify add auth`
	1. select manual configuration
	2. select "connected with IAM" (default)
	3. name `echolocatorStagingAuth`
	4. name `echolocatorStagingIdentityPool`
	5. allow unauthenticated logins? yes
	6. allow third party? no
	7. name `echolocatorStagingUserPool`
	8. sign in with email (only)
	9. add groups? yes
	10. name group `counselors` (only add one group)
	11. admin queries API? no
	12. MFA: off
	13. email based registration: enabled
	14. email verification subject: "Your EchoLocator verification code"
	15. verification message: (default) "Your verification code is {####}"
	16. override password policy: no
	17. attributes for signup: (default) only email
	18. token expiry (default): 30 days
	19. specify R/W attributes? yes
		- email
		- phone number
		- email verified
		- phone number verified
	20. it then says email is already set and asks again; select phone number (other options missing)
	21. add capabilities? none
	22. OAuth flow? no
	23. Cognito triggers? no

- `amplify add storage`
	1. content type
	2. name `echolocatorStagingStorage`
	3. bucket name `echolocator-staging-profiles`
	4. restrict access by: both (auth and groups)
	5. access? auth users only
	6. select all CRUD operation types
	7. select `counselors` group
	8. select all CRUD operation types again
	9. add trigger for bucket? no

- `amplify add api`
	1. service type: REST
	2. echolocatorStagingApi
	3. add path `/clients`
	4. create a new Lambda function
	5. name: `echolocatorStagingClients`
	6. function name: `echolocatorStagingClientsLambda`
	7. Serverless express function
	8. access other resources? yes
	9. select `auth` (storage not needed)
	10. auth resources: `echolocatorStagingAuth` (groups not needed)
	11. select all CRUD operations
	12. edit? no (will do so later)
	13. restrict access? yes
	14. by groups
	15. select `counselors`
	16. select all CRUD operations
	17. add another path? yes
	18. named `/profiles`
	19. create new Lambda function
	20. name: `echolocatorStagingProfiles`
	21. function name: `echolocatorStagingProfilesLambda`
	22. serverless express
	23. access other resources? yes
	24. both `auth` and `storage`
	25. auth resources: `echolocatorStagingAuth` (groups not needed)
	26. select all CRUD operations
	27. select all storage CRUD operations
	28. edit now? no (will edit later)
	29. restrict access? yes
	30. by "auth/guest users"
	31. authenticated users only (called by clients)
	32. access for authenticated users? (select all)
	33. another path? no (whew)

Run `amplify status` to see the components listed; they should all still be in 'Create' status, as they haven't been pushed to AWS yet.


### Modifications

Next, customize the configuration generated by the CLI.


#### Add custom voucher property

Edit the CloudFormation template in `amplify/backend/auth/echolocatorStagingAuth`

under the `Schema` section, add below the `email` property:

```
-
  Name: voucher
  Required: false
  Mutable: false
  AttributeDataType: String
  StringAttributeConstraints:
    MinLength: "6"
    MaxLength: "8"
```

In the `parameters.json` file in the same directory, add `custom:voucher` to `userpoolClientWriteAttributes` and `userpoolClientReadAttributes`.


#### Permissions modifications for S3

Storage configuration files are in `amplify/backend/storage/echolocatorStagingStorage`.

- set S3 parameters.json (`AuthenticatedAllowList`) to DISALLOW to prevent client bucket list
- remove list bucket from `selectedAuthenticatedPermissions` in S3 parameters.json
- remove all permissions from `selectedGuestPermissions` in S3 parameters.json
- change `S3AuthPublicPolicy` resource from "/public/\*" to "/public/*_${cognito-identity.amazonaws.com:sub}" in `s3-cloudformation-template.json`


#### Set up functions

The function configurations are in `amplify/backend/function`.

Add `aws-sdk` as a dependency to the `package.json` files for both functions (and optionally update the autogenerated dependency versions). Also add `uuid-validate` as a dependency to `package.json` for the profiles lambda.

Edit `app.js` for each function to change the code in the example top-level POST method and add appropriate imports, using the code copied from the previous stack. Update the `process.env` variable references in the copied functions to those for the stack for the S3 bucket name and user pool ID. The new values are in the autogenerated comment at the head of the `app.js` file.


#### Modify permissions for bucket list access

Allowing counselors but not clients to have list bucket permissions to search S3 for profiles requires some further changes. Both the profile function and the `counselors` group policy should have their CloudFormation `ListBucket` permissions modified.

In the CloudFormation template for the profiles function, the edit is to the single `Statement` block for S3 permissions (including `ListBucket`). For the `counselors` group policy, edit the CloudFormation template in the storage S3 configuration, under `counselorsGroupPolicy`.

For both, replace the S3 permissions `Statement` block with these two blocks. For the profiles function, the `Ref` in both blocks should be changed from `S3Bucket` to the bucket name parameter defined under `Parameters` in the same file (which should be something like `storageecholocatorStagingStorageBucketName`).

```
{
	"Effect": "Allow",
	"Action": [
	    "s3:PutObject",
	    "s3:GetObject",
	    "s3:DeleteObject"
	],
	"Resource": [
	    {
	        "Fn::Join": [
	            "",
	            [
	                "arn:aws:s3:::",
	                {
	                    "Ref": "S3Bucket"
	                },
	                "/*"
	            ]
	        ]
	    }
	]
	},
	{
	"Effect": "Allow",
	"Action": [
	    "s3:ListBucket"
	],
	"Resource": [
	    {
	        "Fn::Join": [
	            "",
	            [
	                "arn:aws:s3:::",
	                {
	                    "Ref": "S3Bucket"
	                }
	            ]
	        ]
	    }
	],
	"Condition": {
	    "StringLike": {
	        "s3:prefix": [
	            "public/",
	            "public/*"
	        ]
	    }
	}
}
```


### Publishing

 1. `amplify push` to deploy Amplify resources on AWS
 2. copy the configuration file from `src/aws-exports.js` to the `taui/src` directory to use the stack locally
 3. configuration will be bundled with automated CI deployment

### Initial user group setup

Add counselor user accounts using the [AWS Cognito user pool page](https://console.aws.amazon.com/cognito). Add each counselor account to the `counselor` group. Logged-in counselors can then invite client users from within the EchoLocator site.
